name: Discord ‚Äî GitHub Activity

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened]
  push:
    branches:
      - main

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          EVENT_NAME: ${{ github.event_name }}
          ACTION: ${{ github.event.action }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          REF: ${{ github.ref }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          set -e

          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)

          # -----------------------------------------
          # üîí NIVEAU 1 ‚Äî UX √âQUIPE (PREFIX OFFICIEL)
          # -----------------------------------------
          case "$REPO_NAME" in
            oxxymore-docs)
              PREFIX="[DOCS]"
              ;;
            oban-core)
              PREFIX="[CORE]"
              ;;
            oban-prototypes)
              PREFIX="[PROTO]"
              ;;
            oxxymore-tools)
              PREFIX="[TOOLS]"
              ;;
            .github)
              PREFIX="[OPS]"
              ;;
            *)
              PREFIX="[CORE]"
              ;;
          esac

          # -----------------------------------------
          # üéØ Emoji par event
          # -----------------------------------------
          case "$EVENT_NAME" in
            issues)
              EMOJI="üêõ"
              TITLE="Issue $ACTION"
              CONTENT="$ISSUE_TITLE\n$ISSUE_URL"
              ;;
            pull_request)
              EMOJI="üîÄ"
              TITLE="PR $ACTION"
              CONTENT="$PR_TITLE\n$PR_URL"
              ;;
            push)
              EMOJI="üöÄ"
              TITLE="Push on main"
              CONTENT="$COMMIT_MSG"
              ;;
            *)
              EMOJI="üìå"
              TITLE="Activity"
              CONTENT=""
              ;;
          esac

          MESSAGE="$PREFIX $EMOJI $TITLE ‚Äî @$ACTOR\n$CONTENT"

          curl -s -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg content "$MESSAGE" '{content: $content}')"
