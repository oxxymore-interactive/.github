name: GitHub → Discord notifications

on:
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GITHUB_ACTIVITY }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Missing secret: DISCORD_WEBHOOK_GITHUB_ACTIVITY"
            exit 1
          fi

          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          NUMBER="${{ github.event.issue.number }}"

          CONTENT="New issue opened in **${REPO}** by **${ACTOR}**: #${NUMBER} — ${ISSUE_TITLE}\n${ISSUE_URL}"

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "$(python3 - << 'PY'
import json, os
print(json.dumps({"content": os.environ["CONTENT"]}))
PY
            )" \
            "$DISCORD_WEBHOOK"
        shell: bash
        env:
          CONTENT: ${{ format('New issue opened in **{0}** by **{1}**: #{2} — {3}\n{4}', github.repository, github.actor, github.event.issue.number, github.event.issue.title, github.event.issue.html_url) }}
