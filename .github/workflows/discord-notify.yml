name: GitHub ‚Üí Discord notifications

on:
  issues:
    types: [opened, reopened, closed]
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, reopened, closed, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest

    # Gouvernance:
    # - Only run for the org repos (avoid surprises)
    # - Ignore PRs coming from forks
    if: |
      github.repository_owner == 'oxxymore-interactive' &&
      (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false)

    steps:
      - name: Build message
        id: msg
        shell: bash
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY#*/}"

          PREFIX="[CORE]"
          case "$REPO" in
            *docs*|*DOCS*) PREFIX="[DOCS]" ;;
            *.github|*github*) PREFIX="[CORE]" ;;
            *web*|*site*) PREFIX="[WEB]" ;;
          esac

          EVENT="${GITHUB_EVENT_NAME}"

          if [ "$EVENT" = "issues" ]; then
            EMOJI="üêõ"
            ACTION="${{ github.event.action }}"
            NUMBER="${{ github.event.issue.number }}"
            TITLE="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"
            ACTOR="${{ github.actor }}"
            TEXT="$EMOJI $PREFIX Issue #$NUMBER $ACTION by $ACTOR: $TITLE"$'\n'"$URL"

          elif [ "$EVENT" = "push" ]; then
            EMOJI="üöÄ"
            BRANCH="${GITHUB_REF_NAME}"
            ACTOR="${{ github.actor }}"
            COMPARE_URL="${{ github.event.compare }}"
            MSG="${{ github.event.head_commit.message }}"
            SHORT_SHA="${GITHUB_SHA::7}"
            TEXT="$EMOJI $PREFIX Push to $BRANCH by $ACTOR ($SHORT_SHA): $MSG"$'\n'"$COMPARE_URL"

          elif [ "$EVENT" = "pull_request" ]; then
            EMOJI="üîÄ"
            ACTION="${{ github.event.action }}"
            NUMBER="${{ github.event.pull_request.number }}"
            TITLE="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            BASE="${{ github.event.pull_request.base.ref }}"
            ACTOR="${{ github.actor }}"
            TEXT="$EMOJI $PREFIX PR #$NUMBER $ACTION ‚Üí $BASE by $ACTOR: $TITLE"$'\n'"$URL"
          else
            TEXT="‚ÑπÔ∏è $PREFIX Event $EVENT"
          fi

          echo "text<<EOF" >> "$GITHUB_OUTPUT"
          echo "$TEXT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_GITHUB_ACTIVITY }}
          CONTENT: ${{ steps.msg.outputs.text }}
        run: |
          python - <<'PY'
          import os, json, urllib.request

          url = os.environ["DISCORD_WEBHOOK"]
          content = os.environ.get("CONTENT", "").strip()

          payload = {"content": content if content else "‚ÑπÔ∏è GitHub event (empty message)"}
          req = urllib.request.Request(
              url,
              data=json.dumps(payload).encode("utf-8"),
              headers={"Content-Type": "application/json"},
              method="POST"
          )
          with urllib.request.urlopen(req) as r:
              print("Discord status:", r.status)
          PY
